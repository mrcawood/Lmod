#!/bin/bash
# -*- shell-script -*-

packageDir="/Users/mcawood/Lmod/Lmod/rt"; export packageDir
testDir="/Users/mcawood/Lmod/Lmod/rt/cmake"; export testDir
messageFn="/Users/mcawood/Lmod/Lmod/rt/cmake/t1/2024_11_06_15_50_29-Darwin-arm64-cmake/message.lua"; export messageFn
projectDir="/Users/mcawood/Lmod/Lmod"; export projectDir
tag="2024_11_06"; export tag
target=""; export target
testdescriptFn="/Users/mcawood/Lmod/Lmod/rt/cmake/cmake.tdesc"; export testdescriptFn
TARGET=""; export TARGET
cmdResultFn="/Users/mcawood/Lmod/Lmod/rt/cmake/t1/2024_11_06_15_50_29-Darwin-arm64-cmake/results.lua"; export cmdResultFn
packageName="rt"; export packageName
resultFn="/Users/mcawood/Lmod/Lmod/rt/cmake/t1/2024_11_06_15_50_29-Darwin-arm64-cmake/t1.result"; export resultFn
testName="cmake"; export testName
idTag="t1"; export idTag
outputDir="/Users/mcawood/Lmod/Lmod/rt/cmake/t1/2024_11_06_15_50_29-Darwin-arm64-cmake"; export outputDir
runtimeFn="/Users/mcawood/Lmod/Lmod/rt/cmake/t1/2024_11_06_15_50_29-Darwin-arm64-cmake/t1.runtime"; export runtimeFn
CMAKE="/opt/homebrew/bin/cmake"
     . /Users/mcawood/Lmod/Lmod/rt/common_funcs.sh

     unsetMT
     initStdEnvVars
     MODULEPATH_ROOT=/Users/mcawood/Lmod/Lmod/rt/cmake/mf;       export MODULEPATH_ROOT
     MODULEPATH="$MODULEPATH_ROOT/Core";  export MODULEPATH

     rm -rf init .cache .config
     mkdir init
     sed -e 's|@PKG@/libexec/lmod|lua;/Users/mcawood/Lmod/Lmod/src/lmod.in.lua|g' \
              < /Users/mcawood/Lmod/Lmod/init/cmake > init/cmake

cat > cmake.cmake << EOF
include("/Users/mcawood/Lmod/Lmod/rt/cmake/t1/2024_11_06_15_50_29-Darwin-arm64-cmake/init/cmake")

module_avail(AVAIL_MODS)
message("AVAIL_MODS: \${AVAIL_MODS}")

module_list(CURRENT_MODS)
message("CURRENT_MODS: \${CURRENT_MODS}")
message("ENV{FOO}: \$ENV{FOO}")
message("ENV{BAR}: \$ENV{BAR}")

module(load foo)

module_list(CURRENT_MODS)
message("CURRENT_MODS: \${CURRENT_MODS}")
message("ENV{FOO}: \$ENV{FOO}")
message("ENV{BAR}: \$ENV{BAR}")

module_swap(foo foo/1.0)

module_list(CURRENT_MODS)
message("CURRENT_MODS: \${CURRENT_MODS}")
message("ENV{FOO}: \$ENV{FOO}")
message("ENV{BAR}: \$ENV{BAR}")

module(swap foo bar)

module_list(CURRENT_MODS)
message("CURRENT_MODS: \${CURRENT_MODS}")
message("ENV{FOO}: \$ENV{FOO}")
message("ENV{BAR}: \$ENV{BAR}")

module(load bad)

EOF

     remove_generated_lmod_files results.csv

     $CMAKE -P ./cmake.cmake  > _stdout.000 2> _stderr.000

     HOME=$ORIG_HOME

     cleanUp _stdout.000 out.txt
     cleanUp _stderr.000 err.txt
     wrapperDiff --csv results.csv /Users/mcawood/Lmod/Lmod/rt/cmake/out.txt out.txt
     wrapperDiff --csv results.csv /Users/mcawood/Lmod/Lmod/rt/cmake/err.txt err.txt
     testFinish -r /Users/mcawood/Lmod/Lmod/rt/cmake/t1/2024_11_06_15_50_29-Darwin-arm64-cmake/t1.result -t /Users/mcawood/Lmod/Lmod/rt/cmake/t1/2024_11_06_15_50_29-Darwin-arm64-cmake/t1.runtime results.csv
   